
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!--
    ¬© 2026 Roberto Fettuccia
    Todos os direitos reservados.

    Este c√≥digo √© protegido por direitos autorais.
    Uso, c√≥pia ou redistribui√ß√£o somente mediante autoriza√ß√£o.

    Contato para licenciamento:
    üìß corretor.fettuccia@gmail.com
    üì± +55 (51) 9981-11078

    Que Deus aben√ßoe nosso dia a dia.!
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Imobili√°ria Profissional</title>
    <style>
    :root{
       --fontSize: 12px;
       --headfontmultip:4;
    }
        * {
        
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 10px;
            font-size: var(--fontSize);
            color: #1e293b;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 12px 12px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .main-content {
            padding: 10px;
        }
        
        /* Identifica√ß√£o do Neg√≥cio */
        .negocio-container {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .negocio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .negocio-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .negocio-header h2 i {
            color: #3b82f6;
        }
        
        .negocio-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .negocio-form {
                grid-template-columns: 1fr;
            }
        }
        
        .negocio-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .negocio-label {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .negocio-input {
            width: 100%;
            padding: 10px 10px;
            font-size: 16px;
            font-weight: 500;
            color: #1e3a8a;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .negocio-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            background: white;
        }
        
        .negocio-proposta {
            font-size: 12px;
            color: #94a3b8;
            font-style: italic;
            margin-top: 4px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 2px;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }
        
        .card-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 4px;
        }
        
        .card-subtext {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .valor-imovel-container {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .valor-imovel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .valor-imovel-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .valor-imovel-header h2 i {
            color: #3b82f6;
        }
        
        .valor-input-group {
            position: relative;
            margin-bottom: 5px;
        }
        
        .currency-input-container {
            position: relative;
            width: 100%;
        }
        
        .currency-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            font-weight: 500;
            color: #1e3a8a;
            z-index: 2;
            pointer-events: none;
        }
        
        .currency-input {
            width: 100%;
            padding: 2px 2px 2px 2px;
            font-size: 28px;
            font-weight: 700;
            color: #1e3a8a;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: right;
            background: #f8fafc;
            transition: all 0.3s ease;
            font-family: 'Inter', monospace;
            letter-spacing: 0.5px;
        }
        
        .currency-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            background: white;
        }
        
        .slider-container {
            padding: 0 10px;
            margin-top: 20px;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 4px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
        }
        
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 10px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .panel-header h2 i {
            color: #3b82f6;
        }
        
        .panel-body {
            padding: 3px;
        }
        
        .payment-types-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .type-btn {
            padding: 5px 5px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s ease;
            color: #475569;
        }
        
        .type-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            transform: translateY(-1px);
        }
        
        .type-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 3px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .currency-field {
            position: relative;
        }
        
        .currency-field .form-input {
            padding-left: 40px;
            font-family: 'Inter', monospace;
            letter-spacing: 0.5px;
        }
        
        .field-currency {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: #475569;
            pointer-events: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .date-label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .btn {
            padding: 10px 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .toolbar .btn {
            flex: 1;
            min-width: 140px;
        }
        
        .payment-blocks-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .payment-blocks-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .payment-blocks-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .payment-blocks-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .payment-blocks-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .payment-block {
            background: white;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .payment-block:hover {
            transform: translateX(4px);
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1px;
        }
        
        .block-badge {
            display: inline-flex;
            align-items: center;
            gap: 1px;
            padding: 1px 0px;
            background: #f1f5f9;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: #475569;
        }
        
        .remove-block {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .remove-block:hover {
            color: #ef4444;
            background: #fef2f2;
        }
        
        .block-content {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .block-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .block-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }
        
        .block-parcelamento {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }
        
        .parcelamento-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .parcelamento-text {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        .parcelamento-value {
            font-size: 13px;
            color: #1e3a8a;
            font-weight: 600;
            font-family: 'Inter', monospace;
        }
        
        .block-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2px;
            padding-top: 2px;
            border-top: 1px solid #e2e8f0;
        }
        
        .total-label {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }
        
        .total-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
            font-family: 'Inter', monospace;
            letter-spacing: 0.5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #94a3b8;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #64748b;
        }
        
        .empty-state p {
            font-size: 13px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            width: 100%;
        }
        
        .chart-container {
            margin-top: 32px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .chart {
            height: 80px;
            background: #f8fafc;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-progress {
            height: 100%;
            background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 6px;
            transition: width 1s ease;
        }
        
        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: #64748b;
        }
        
        footer {
            padding: 20px 32px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 12px;
            color: #64748b;
        }
        
        /* Estilos para impress√£o */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 12px !important;
            }
            
            .container {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .btn, .toolbar, .slider-container, .slider-labels {
                display: none !important;
            }
            
            .currency-input {
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                color: #1e3a8a !important;
                font-size: calc(var(--fontSize) * var(--headfontmultip)); !important;
                padding: 0 !important;
                text-align: right !important;
            }
            
            .currency-prefix {
                position: static !important;
                display: inline !important;
                font-size: 24px !important;
                margin-right: 5px !important;
            }
            
            .currency-input-container {
                display: flex !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
            
            .valor-input-group {
                margin-bottom: 0px !important;
            }
            
            .payment-block {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }
            
            .summary-card {
                page-break-inside: avoid !important;
            }
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-types-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .toolbar .btn {
                min-width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .payment-types-grid {
                grid-template-columns: 1fr;
            }
            
            .toolbar {
                flex-direction: column;
            }
            
            .toolbar .btn {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca jsPDF para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1><i class="fas fa-calculator"></i> Calculadora Imobili√°ria</h1>
                <p class="subtitle">Planejamento financeiro profissional para transa√ß√µes imobili√°rias</p>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Identifica√ß√£o do Neg√≥cio -->
            <div class="negocio-container">
                <div class="negocio-header">
                    <h2><i class="fas fa-tag"></i> Identifica√ß√£o do Neg√≥cio</h2>
                    <div class="card-subtext">Identifique a proposta para refer√™ncia futura</div>
                </div>
                <div class="negocio-form">
                    <div class="negocio-input-group">
                        <label class="negocio-label">Nome do Neg√≥cio / Im√≥vel</label>
                        <input type="text" class="negocio-input" id="negocioNome" placeholder="Ex: Unidade 01 - torre Y - Cliente X" value="">
                        <div class="negocio-proposta">Use um nome descritivo para f√°cil identifica√ß√£o</div>
                    </div>
                    <div class="negocio-input-group">
                        <label class="negocio-label">C√≥digo da Proposta</label>
                        <input type="text" class="negocio-input" id="negocioCodigo" placeholder="Ex: PRO-2026-001" value="">
                        <div class="negocio-proposta">N√∫mero √∫nico para refer√™ncia</div>
                    </div>
                </div>
            </div>
            
            <!-- Resumo Superior -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-label">Valor do Im√≥vel</div>
                    <div class="card-value" id="summaryPropertyValue"></div>
                    <div class="card-subtext">Valor total do bem</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">Total Financiado</div>
                    <div class="card-value" id="summaryTotalPayments">R$ 0,00</div>
                    <div class="card-subtext">Soma de todos os pagamentos</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">Saldo Restante</div>
                    <div class="card-value" id="summaryRemainingBalance">R$ 0,00</div>
                    <div class="card-subtext">Diferen√ßa a ser coberta</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">Parcelas</div>
                    <div class="card-value" id="summaryInstallments">81</div>
                    <div class="card-subtext">Total de eventos financeiros</div>
                </div>
            </div>
            
            <!-- Valor do Im√≥vel DESTACADO (acima das formas de pagamento) -->
            <div class="valor-imovel-container">
                <div class="valor-imovel-header">
                    <h2><i class="fas fa-home"></i> Valor do Im√≥vel</h2>
                    <div class="card-subtext">Digite o valor ou ajuste com o controle</div>
                </div>
                <div class="valor-input-group">
                    <div class="currency-input-container">
                        <span class="currency-prefix">R$</span>
                        <span id="propertyValueDisplay" style="display:none" class="currency-input-display">0,00</span>
                        <input type="text" class="currency-input no-print" id="propertyValue" value="0,00">
                    </div>
                </div>
                <div class="slider-container no-print" style="display:none">
                    <input type="range" min="0" max="10000000" step="10000" value="0" class="slider" id="propertySlider">
                    <div class="slider-labels">
                        <span>R$ 0</span>
                        <span>R$ 5.000.000</span>
                        <span>R$ 10.000.000</span>
                    </div>
                </div>
            </div>
            
            <!-- Grid Principal -->
            <div class="content-grid">
                <!-- Painel Esquerdo: Adicionar Pagamentos (N√ÉO aparece na impress√£o) -->
                <div class="panel no-print">
                    <div class="panel-header">
                        <h2><i class="fas fa-plus-circle"></i> Adicionar Forma de Pagamento</h2>
                    </div>
                    <div class="panel-body">
                        <div class="payment-types-grid">
                            <div class="type-btn active" data-type="ato">
                                <i class="fas fa-file-signature"></i> Ato
                            </div>
                            <div class="type-btn" data-type="reforco">
                                <i class="fas fa-plus-square"></i> Refor√ßo
                            </div>
                            <div class="type-btn" data-type="parcelamento">
                                <i class="fas fa-calendar-alt"></i> Parcelamento
                            </div>
                            <div class="type-btn" data-type="dacao">
                                <i class="fas fa-exchange-alt"></i> Da√ß√£o
                            </div>
                            <div class="type-btn" data-type="financiamento">
                                <i class="fas fa-university"></i> Financiamento
                            </div>
                            <div class="type-btn" data-type="custom">
                                <i class="fas fa-cog"></i> Personalizado
                            </div>
                        </div>
                        
                        <div id="paymentForm">
                            <!-- Formul√°rio din√¢mico ser√° inserido aqui -->
                        </div>
                        
                        <button class="btn btn-primary" id="addPayment">
                            <i class="fas fa-plus"></i> Adicionar Pagamento
                        </button>
                        
                        <div class="toolbar">
                            <button class="btn btn-secondary" id="resetAll">
                                <i class="fas fa-redo"></i> Redefinir
                            </button>
                            <button class="btn btn-danger" id="clearAll">
                                <i class="fas fa-trash"></i> Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Painel Direito: Lista de Pagamentos (APARECE na impress√£o) -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-list-check"></i> Formas de Pagamento</h2>
                    </div>
                    <div class="panel-body">
                        <div class="payment-blocks-container" id="paymentBlocks">
                            <!-- Blocos ser√£o inseridos aqui -->
                        </div>
                        
                        <div class="toolbar no-print">
                            <button class="btn btn-success" id="savePDF">
                                <i class="fas fa-file-pdf"></i> Salvar PDF
                            </button>
                            <button class="btn btn-secondary" id="print">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                            <button class="btn btn-secondary" id="exportJSON">
                                <i class="fas fa-file-export"></i> Exportar JSON
                            </button>
                            <label class="btn btn-secondary">
                                <i class="fas fa-file-import"></i> Importar JSON
                                <input type="file" accept=".json" class="file-input" id="importJSON">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°fico de Progresso -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Progresso do Financiamento - <span id="chartNegocioNome">Im√≥vel 22 - Empresarial</span></div>
                    <div id="chartPercentage">100%</div>
                </div>
                <div class="chart">
                    <div class="chart-progress" id="chartProgress" style="width: 100%"></div>
                </div>
                <div class="chart-labels">
                    <span>In√≠cio (R$ 0)</span>
                    <span>50%</span>
                    <span>Meta (R$ <span id="chartTarget">0,00</span>)</span>
                </div>
            </div>
        </div>
        
        <footer>
            <p>¬© 2026 Calculadora Imobili√°ria Profissional - By. Roberto Fettuccia | Proposta: <span id="footerNegocioNome">Im√≥vel 22 - Empresarial</span> - <span id="footerNegocioCodigo">PRO-2024-001</span></p>
            <p style="margin-top: 4px; font-size: 11px;">Para uso em transa√ß√µes e planejamento financeiro imobili√°rio</p>
        </footer>
    </div>

    <script>
        // Dados iniciais
        let paymentBlocks = [
            {
                id: 1,
                type: 'ato',
                label: 'Ato - Entrada Inicial',
                value: 0.00,
                date: '12/2025',
                total: 0.00
            },
            {
                id: 2,
                type: 'parcelamento',
                label: 'Parcelas Mensais',
                value: 0.00,
                installments: 9,
                start: '05/2026',
                end: '09/2028',
                total: 0.00
            },
            {
                id: 3,
                type: 'reforco',
                label: 'Refor√ßo Anual 2026',
                value: 0.00,
                date: '09/2026',
                total: 0.00
            },
            {
                id: 6,
                type: 'financiamento',
                label: 'Financiamento Banc√°rio',
                value: 0.00,
                date: '12/2029',
                total: 0.00
            }
        ];

        let propertyValue = 300000;
        let selectedType = 'ato';
        let nextId = 7;
        
        // Dados do neg√≥cio
        let negocioNome = "";
        let negocioCodigo = "";

        // Elementos DOM
        const propertyValueInput = document.getElementById('propertyValue');
        const propertyValueDisplay = document.getElementById('propertyValueDisplay');
        const propertySlider = document.getElementById('propertySlider');
        const paymentBlocksContainer = document.getElementById('paymentBlocks');
        const paymentFormContainer = document.getElementById('paymentForm');
        const typeButtons = document.querySelectorAll('.type-btn');
        const addPaymentBtn = document.getElementById('addPayment');
        const resetAllBtn = document.getElementById('resetAll');
        const clearAllBtn = document.getElementById('clearAll');
        const savePDFBtn = document.getElementById('savePDF');
        const printBtn = document.getElementById('print');
        const exportJSONBtn = document.getElementById('exportJSON');
        const importJSONInput = document.getElementById('importJSON');
        
        // Elementos do neg√≥cio
        const negocioNomeInput = document.getElementById('negocioNome');
        const negocioCodigoInput = document.getElementById('negocioCodigo');
        const chartNegocioNome = document.getElementById('chartNegocioNome');
        const footerNegocioNome = document.getElementById('footerNegocioNome');
        const footerNegocioCodigo = document.getElementById('footerNegocioCodigo');

        // Elementos de resumo
        const summaryPropertyValue = document.getElementById('summaryPropertyValue');
        const summaryTotalPayments = document.getElementById('summaryTotalPayments');
        const summaryRemainingBalance = document.getElementById('summaryRemainingBalance');
        const summaryInstallments = document.getElementById('summaryInstallments');
        const chartProgress = document.getElementById('chartProgress');
        const chartPercentage = document.getElementById('chartPercentage');
        const chartTarget = document.getElementById('chartTarget');

        // √çcones por tipo
        const typeIcons = {
            'ato': 'fa-file-signature',
            'reforco': 'fa-plus-square',
            'parcelamento': 'fa-calendar-alt',
            'dacao': 'fa-exchange-alt',
            'financiamento': 'fa-university',
            'custom': 'fa-cog'
        };

        // Labels por tipo
        const typeLabels = {
            'ato': 'Ato',
            'reforco': 'Refor√ßo',
            'parcelamento': 'Parcelamento',
            'dacao': 'Da√ß√£o',
            'financiamento': 'Financiamento',
            'custom': 'Personalizado'
        };
        // Fun√ß√£o para formatar n√∫mero para moeda BRL
        function formatToBRL(value) {
            if (typeof value === 'string') {
                value = parseFloat(value.replace(/[^\d.-]/g, ''));
            }
            
            if (isNaN(value)) value = 0;
            
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Fun√ß√£o para formatar n√∫mero para exibi√ß√£o (sem R$)
        function formatNumber(value) {
            if (typeof value === 'string') {
                value = parseFloat(value.replace(/[^\d.-]/g, ''));
            }
            
            if (isNaN(value)) value = 0;
            
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Nova fun√ß√£o para aplicar m√°scara de moeda BRL
        function setupCurrencyInput(inputElement, onChangeCallback) {
            // Configura√ß√£o inicial
            let value = inputElement.value.replace(/[^\d]/g, '');
            let numericValue = parseFloat(value) / 100 || 0;
            inputElement.value = formatNumber(numericValue);
            
            // Evento de input
            inputElement.addEventListener('input', function(e) {
                // Salva posi√ß√£o do cursor
                const cursorPosition = this.selectionStart;
                const originalLength = this.value.length;
                
                // Remove tudo que n√£o √© d√≠gito
                let value = this.value.replace(/[^\d]/g, '');
                
                // Converte para n√∫mero (centavos)
                let numericValue = parseFloat(value) / 100 || 0;
                
                // Formata o valor
                let formattedValue = formatNumber(numericValue);
                
                // Atualiza o campo
                this.value = formattedValue;
                
                // Calcula nova posi√ß√£o do cursor
                const newLength = this.value.length;
                const lengthDiff = newLength - originalLength;
                const newCursorPosition = cursorPosition + lengthDiff;
                
                // Mant√©m cursor na posi√ß√£o correta
                setTimeout(() => {
                    this.setSelectionRange(newCursorPosition, newCursorPosition);
                }, 0);
                
                // Atualiza display e chama callback
                if (propertyValueDisplay) {
                    propertyValueDisplay.textContent = formatNumber(numericValue);
                }
                
                if (onChangeCallback) {
                    onChangeCallback(numericValue);
                }
            });
            
            // Evento de blur (quando sai do campo)
            inputElement.addEventListener('blur', function() {
                let value = this.value.replace(/[^\d]/g, '');
                let numericValue = parseFloat(value) / 100 || 0;
                this.value = formatNumber(numericValue);
                
                if (propertyValueDisplay) {
                    propertyValueDisplay.textContent = formatNumber(numericValue);
                }
                
                if (onChangeCallback) {
                    onChangeCallback(numericValue);
                }
            });
            
            // Evento de focus (quando entra no campo)
            inputElement.addEventListener('focus', function() {
                // Mant√©m o valor formatado, mas seleciona todo o texto para facilitar edi√ß√£o
                this.select();
            });
            
            // Evento de keydown - permite apenas n√∫meros, backspace, delete e navega√ß√£o
            inputElement.addEventListener('keydown', function(e) {
                // Permite: backspace, delete, tab, escape, enter, navega√ß√£o (setas)
                if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
                    (e.keyCode === 65 && e.ctrlKey === true) || // Ctrl+A
                    (e.keyCode === 67 && e.ctrlKey === true) || // Ctrl+C
                    (e.keyCode === 86 && e.ctrlKey === true) || // Ctrl+V
                    (e.keyCode === 88 && e.ctrlKey === true) || // Ctrl+X
                    (e.keyCode >= 35 && e.keyCode <= 39)) { // Home, End, setas
                    return;
                }
                
                // Impede qualquer coisa que n√£o seja n√∫mero
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }

        // Fun√ß√£o para obter o valor num√©rico de um campo de moeda
        function getCurrencyValue(inputElement) {
            let value = inputElement.value.replace(/[^\d]/g, '');
            return parseFloat(value) / 100 || 0;
        }
// Fun√ß√£o para calcular data final baseada na data in√≠cio e n√∫mero de parcelas
        function calculateEndDate(startDate, installments) {
            if (!startDate || !installments || installments <= 1) return startDate;
            
            // Parse da data in√≠cio (formato MM/AAAA)
            const [startMonth, startYear] = startDate.split('/').map(Number);
            
            // Calcula o m√™s final (subtrai 1 porque a primeira parcela √© no m√™s in√≠cio)
            let endMonth = startMonth + installments - 1;
            let endYear = startYear;
            
            // Ajusta se passar de dezembro
            while (endMonth > 12) {
                endMonth -= 12;
                endYear += 1;
            }
            
            // Formata com zero √† esquerda para m√™s
            const formattedMonth = endMonth.toString().padStart(2, '0');
            return `${formattedMonth}/${endYear}`;
        }

        // Fun√ß√£o para atualizar data final quando n√∫mero de parcelas ou data in√≠cio mudar
        function updateEndDate() {
            if (selectedType !== 'parcelamento') return;
            
            const installmentsInput = document.getElementById('installments');
            const startDateInput = document.getElementById('start');
            const endDateInput = document.getElementById('end');
            
            if (!installmentsInput || !startDateInput || !endDateInput) return;
            
            const installments = parseInt(installmentsInput.value) || 1;
            const startDate = startDateInput.value.trim();
            
            if (startDate && startDate.includes('/')) {
                const endDate = calculateEndDate(startDate, installments);
                endDateInput.value = endDate;
            }
        }

        // Fun√ß√£o para atualizar informa√ß√µes do neg√≥cio
        function updateNegocioInfo() {
            negocioNome = negocioNomeInput.value || "N√£o identificado";
            negocioCodigo = negocioCodigoInput.value || "Sem c√≥digo";
            
            chartNegocioNome.textContent = negocioNome;
            footerNegocioNome.textContent = negocioNome;
            footerNegocioCodigo.textContent = negocioCodigo;
        }

        // Inicializar
        function init() {
            // Configurar input de valor do im√≥vel
            setupCurrencyInput(propertyValueInput, function(value) {
                propertyValue = value;
                propertySlider.value = propertyValue;
                updatePropertyValue();
            });
            
            // Configurar eventos do neg√≥cio
            negocioNomeInput.addEventListener('input', updateNegocioInfo);
            negocioCodigoInput.addEventListener('input', updateNegocioInfo);
            
            updateNegocioInfo();
            updatePropertyValue();
            renderPaymentForm();
            renderPaymentBlocks();
            updateSummary();
            
            // Event listeners
            propertySlider.addEventListener('input', function() {
                propertyValue = parseFloat(this.value);
                const formatted = formatNumber(propertyValue);
                propertyValueInput.value = formatted;
                propertyValueDisplay.textContent = formatted;
                updatePropertyValue();
            });
            
            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedType = this.dataset.type;
                    renderPaymentForm();
                });
            });
            
            addPaymentBtn.addEventListener('click', addPayment);
            resetAllBtn.addEventListener('click', resetToDefault);
            clearAllBtn.addEventListener('click', clearAllPayments);
            savePDFBtn.addEventListener('click', saveAsPDF);
            printBtn.addEventListener('click', printDocument);
            exportJSONBtn.addEventListener('click', exportToJSON);
            importJSONInput.addEventListener('change', importFromJSON);
        }

        // Atualizar valor do im√≥vel
        function updatePropertyValue() {
            summaryPropertyValue.textContent = formatToBRL(propertyValue);
            chartTarget.textContent = formatToBRL(propertyValue);
            updateSummary();
        }

        // Renderizar formul√°rio baseado no tipo
        function renderPaymentForm() {
            let html = '';
            
            switch(selectedType) {
                case 'ato':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Ato - Entrada Inicial" id="desc" class="form-input" value="Ato - Entrada Inicial">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="0,00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="date" class="form-input" value="12/2025">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'reforco':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Refor√ßo Anual" id="desc" class="form-input" value="Refor√ßo Anual">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="0,00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="date" class="form-input" value="09/2026">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'parcelamento':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Parcelas Mensais" id="desc" class="form-input" value="Parcelas Mensais">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor da Parcela</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="0,00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Parcelas</label>
                                <input type="number" placeholder="1" id="installments" class="form-input" value="12" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group date-input-group">
                                <label class="form-label">Data In√≠cio (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="start" class="form-input" value="05/2026">
                                <div class="date-label">Primeira parcela</div>
                            </div>
                            <div class="form-group date-input-group">
                                <label class="form-label">Data Fim (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="end" class="form-input" value="09/2028" readonly>
                                <div class="date-label">Calculado automaticamente</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'dacao':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Da√ß√£o em Pagamento" id="desc" class="form-input" value="Da√ß√£o em Pagamento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor da Da√ß√£o</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="0,00">
                                </div>
                        </div>
                    `;
                    break;
                    
                case 'financiamento':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Financiamento Banc√°rio" id="desc" class="form-input" value="Financiamento Banc√°rio">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="date" class="form-input" value="12/2029">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'custom':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" placeholder="Ex: Pagamento Personalizado" id="desc" class="form-input" value="Pagamento Personalizado">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor</label>
                                <div class="currency-field">
                                    <span class="field-currency">R$</span>
                                    <input type="text" placeholder="0,00" id="value" class="form-input" value="0,00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data (MM/AAAA)</label>
                                <input type="text" placeholder="MM/AAAA" id="date" class="form-input" value="01/2025">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de Parcelas (opcional)</label>
                            <input type="number" placeholder="1" id="installments" class="form-input" value="1" min="1">
                        </div>
                    `;
                    break;
            }
            
            paymentFormContainer.innerHTML = html;
            
            // Configurar m√°scara de moeda nos campos de valor
            setTimeout(() => {
                const valueInput = document.getElementById('value');
                if (valueInput) {
                    setupCurrencyInput(valueInput);
                }
                
                // Configurar eventos para c√°lculo autom√°tico de data final (apenas para parcelamento)
                if (selectedType === 'parcelamento') {
                    const installmentsInput = document.getElementById('installments');
                    const startDateInput = document.getElementById('start');
                    
                    if (installmentsInput && startDateInput) {
                        installmentsInput.addEventListener('input', updateEndDate);
                        startDateInput.addEventListener('input', updateEndDate);
                        
                        // Calcular data inicial automaticamente
                        updateEndDate();
                    }
                }
            }, 0);
        }

        // Adicionar pagamento
        function addPayment() {
            const desc = document.getElementById('desc')?.value || 'Pagamento';
            const valueInput = document.getElementById('value');
                const value = valueInput ? getCurrencyValue(valueInput) : 0;
if (value <= 0) {
                alert('Por favor, insira um valor v√°lido maior que zero.');
                return;
            }
            
            let newPayment = {
                id: nextId++,
                type: selectedType,
                label: desc,
                value: value
            };
            
            // Adicionar campos espec√≠ficos
            switch(selectedType) {
                case 'ato':
                case 'reforco':
                case 'financiamento':
                    newPayment.date = document.getElementById('date')?.value || '';
                    newPayment.total = value;
                    break;
                case 'parcelamento':
                    const installments = parseInt(document.getElementById('installments')?.value) || 1;
                    newPayment.installments = installments;
                    newPayment.start = document.getElementById('start')?.value || '';
                    newPayment.end = document.getElementById('end')?.value || '';
                    newPayment.total = value * installments;
                    break;
                case 'dacao':
                    newPayment.total = value;
                    break;
                case 'custom':
                    newPayment.date = document.getElementById('date')?.value || '';
                    const customInstallments = parseInt(document.getElementById('installments')?.value) || 1;
                    newPayment.installments = customInstallments > 1 ? customInstallments : undefined;
                    newPayment.total = value * (customInstallments || 1);
                    break;
            }
            
            paymentBlocks.push(newPayment);
            renderPaymentBlocks();
            updateSummary();
            
            // Limpar formul√°rio
            document.getElementById('desc').value = '';
            if (valueInput) valueInput.value = '0,00';
        }

        // Renderizar blocos de pagamento com formata√ß√£o melhorada para parcelamento
        function renderPaymentBlocks() {
            if (paymentBlocks.length === 0) {
                paymentBlocksContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>Nenhuma forma de pagamento adicionada</h3>
                        <p>Adicione formas de pagamento usando o painel √† esquerda</p>
                    </div>
                `;
                return;
            }
            
            paymentBlocksContainer.innerHTML = '';
            
            paymentBlocks.forEach(block => {
                const blockEl = document.createElement('div');
                blockEl.className = 'payment-block';
                blockEl.innerHTML = getBlockHTML(block);
                paymentBlocksContainer.appendChild(blockEl);
            });
            
            // Adicionar event listeners para remover
            document.querySelectorAll('.remove-block').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    paymentBlocks = paymentBlocks.filter(b => b.id !== id);
                    renderPaymentBlocks();
                    updateSummary();
                });
            });
        }

        // Gerar HTML para cada tipo de bloco (com formata√ß√£o especial para parcelamento)
        function getBlockHTML(block) {
            let contentHTML = '';
            
            if (block.type === 'parcelamento') {
                contentHTML = `
                    <div class="block-details">
                        <div class="block-title">${block.label}</div>
                        <div class="block-parcelamento">
                            <div class="parcelamento-line">
                                <span class="parcelamento-text">${block.installments} vezes de</span>
                                <span class="parcelamento-value">${formatToBRL(block.value)}</span>
                            </div>
                            <div class="parcelamento-line">
                                <span class="parcelamento-text">De ${block.start || '?'} a ${block.end || '?'}</span>
                                <span class="parcelamento-text">Mensal</span>
                            </div>
                        </div>
                    </div>
                    <div class="block-total">
                        <span class="total-label">Total do Parcelamento</span>
                        <span class="total-value">${formatToBRL(block.total)}</span>
                    </div>
                `;
            } else {
                let details = '';
                
                switch(block.type) {
                    case 'ato':
                    case 'reforco':
                    case 'financiamento':
                        details = `Data: ${block.date || 'N√£o especificada'}`;
                        break;
                    case 'dacao':
                        details = 'Da√ß√£o em pagamento';
                        break;
                    case 'custom':
                        if (block.installments && block.installments > 1) {
                            details = `${block.installments} parcelas ${block.date ? `(${block.date})` : ''}`;
                        } else {
                            details = `${block.date ? `Data: ${block.date}` : 'Pagamento √∫nico'}`;
                        }
                        break;
                }
                
                contentHTML = `
                    <div class="block-details">
                        <div class="block-title">${block.label}</div>
                        <div class="parcelamento-text">${details}</div>
                    </div>
                    <div class="block-total">
                        <span class="total-label">Valor Total</span>
                        <span class="total-value">${formatToBRL(block.total || block.value)}</span>
                    </div>
                `;
            }
            
            return `
                <div class="block-header">
                    <div class="block-badge">
                        <i class="fas ${typeIcons[block.type]}"></i>
                        ${typeLabels[block.type]}
                    </div>
                    <button class="remove-block no-print" data-id="${block.id}" title="Remover">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="block-content">
                    ${contentHTML}
                </div>
            `;
        }

        // Atualizar resumo
        function updateSummary() {
            let totalPayments = 0;
            let totalInstallments = 0;
            
            paymentBlocks.forEach(block => {
                totalPayments += block.total || block.value;
                if (block.type === 'parcelamento') {
                    totalInstallments += block.installments || 1;
                } else if (block.installments && block.installments > 1) {
                    totalInstallments += block.installments;
                } else {
                    totalInstallments += 1;
                }
            });
            
            const remaining = propertyValue - totalPayments;
            const percentage = propertyValue > 0 ? ((propertyValue - remaining) / propertyValue) * 100 : 0;
            
            summaryTotalPayments.textContent = formatToBRL(totalPayments);
            summaryRemainingBalance.textContent = formatToBRL(remaining);
            summaryInstallments.textContent = totalInstallments;
            
            // Cor do saldo
            if (remaining > 0) {
                summaryRemainingBalance.style.color = '#ef4444';
            } else if (remaining < 0) {
                summaryRemainingBalance.style.color = '#10b981';
            } else {
                summaryRemainingBalance.style.color = '#1e3a8a';
            }
            
            // Atualizar gr√°fico
            chartProgress.style.width = `${Math.min(100, percentage)}%`;
            chartPercentage.textContent = `${percentage.toFixed(1)}%`;
        }

        // Gerar PDF da proposta
        async function saveAsPDF() {
            try {
                // Mostrar mensagem de carregamento
                savePDFBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';
                savePDFBtn.disabled = true;
                
                // Calcular totais
                let totalPayments = 0;
                paymentBlocks.forEach(block => {
                    totalPayments += block.total || block.value;
                });
                
                const remaining = propertyValue - totalPayments;
                const percentage = propertyValue > 0 ? ((propertyValue - remaining) / propertyValue) * 100 : 0;
                
                // Criar documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configura√ß√µes
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Adicionar data e hora
                const now = new Date();
                const dataHora = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                // Cabe√ßalho
                doc.setFontSize(20);
                doc.setTextColor(30, 58, 138); // #1e3a8a
                doc.setFont('helvetica', 'bold');
                doc.text('Proposta Imobili√°ria', margin, 20);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139); // #64748b
                doc.setFont('helvetica', 'normal');
                doc.text(`C√≥digo: ${negocioCodigo}`, margin, 30);
                doc.text(`Emitido em: ${dataHora}`, pageWidth - margin - doc.getTextWidth(`Emitido em: ${dataHora}`), 30);
                
                // Linha separadora
                doc.setDrawColor(226, 232, 240); // #e2e8f0
                doc.line(margin, 35, pageWidth - margin, 35);
                
                // Informa√ß√µes do Neg√≥cio
                doc.setFontSize(14);
                doc.setTextColor(30, 41, 59); // #1e293b
                doc.setFont('helvetica', 'bold');
                doc.text('Identifica√ß√£o do Neg√≥cio', margin, 45);
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Nome do Im√≥vel: ${negocioNome}`, margin, 55);
                doc.text(`C√≥digo da Proposta: ${negocioCodigo}`, margin, 62);
                
                // Resumo Financeiro
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Resumo Financeiro', margin, 75);
                
                // Tabela de resumo
                const summaryData = [
                    ['Valor do Im√≥vel', formatToBRL(propertyValue)],
                    ['Total Financiado', formatToBRL(totalPayments)],
                    ['Saldo Restante', formatToBRL(remaining)],
                    ['Parcelas', summaryInstallments.textContent],
                    ['Progresso', `${percentage.toFixed(1)}%`]
                ];
                
                doc.autoTable({
                    startY: 80,
                    head: [['Descri√ß√£o', 'Valor']],
                    body: summaryData,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 58, 138], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin },
                    tableWidth: contentWidth,
                    styles: { fontSize: 10, cellPadding: 5 },
                    columnStyles: {
                        0: { cellWidth: contentWidth * 0.6 },
                        1: { cellWidth: contentWidth * 0.4, halign: 'right' }
                    }
                });
                
                let finalY = doc.lastAutoTable.finalY + 10;
                
                // Formas de Pagamento
                if (paymentBlocks.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Formas de Pagamento', margin, finalY);
                    
                    finalY += 10;
                    
                    // Preparar dados para tabela
                    const tableData = [];
                    paymentBlocks.forEach((block, index) => {
                        let descricao = block.label;
                        let detalhes = '';
                        let valor = formatToBRL(block.total || block.value);
                        
                        if (block.type === 'parcelamento') {
                            detalhes = `${block.installments}x de ${formatToBRL(block.value)} (${block.start} a ${block.end})`;
                        } else if (block.type === 'ato' || block.type === 'reforco' || block.type === 'financiamento') {
                            detalhes = block.date ? `Data: ${block.date}` : 'Pagamento √∫nico';
                        } else if (block.type === 'dacao') {
                            detalhes = 'Da√ß√£o em pagamento';
                        } else if (block.type === 'custom') {
                            detalhes = block.installments && block.installments > 1 ? 
                                `${block.installments} parcelas ${block.date ? `(${block.date})` : ''}` : 
                                (block.date ? `Data: ${block.date}` : 'Pagamento √∫nico');
                        }
                        
                        tableData.push([typeLabels[block.type], descricao, detalhes, valor]);
                    });
                    
                    // Adicionar tabela de formas de pagamento
                    doc.autoTable({
                        startY: finalY,
                        head: [['Tipo', 'Descri√ß√£o', 'Detalhes', 'Valor']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [59, 130, 246], textColor: [255, 255, 255] },
                        margin: { left: margin, right: margin },
                        tableWidth: contentWidth,
                        styles: { fontSize: 9, cellPadding: 4 },
                        columnStyles: {
                            0: { cellWidth: contentWidth * 0.15 },
                            1: { cellWidth: contentWidth * 0.3 },
                            2: { cellWidth: contentWidth * 0.35 },
                            3: { cellWidth: contentWidth * 0.2, halign: 'right' }
                        },
                        didDrawPage: function(data) {
                            // Adicionar n√∫mero da p√°gina
                            const pageCount = doc.internal.getNumberOfPages();
                            doc.setFontSize(8);
                            doc.setTextColor(100, 116, 139);
                            doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10);
                        }
                    });
                    
                    finalY = doc.lastAutoTable.finalY + 10;
                }
                
                // Gr√°fico de progresso (simplificado)
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Progresso do Financiamento', margin, finalY);
                
                finalY += 5;
                
                // Barra de progresso
                const barWidth = contentWidth * (percentage / 100);
                doc.setFillColor(30, 58, 138); // #1e3a8a
                doc.rect(margin, finalY, barWidth, 8, 'F');
                doc.setDrawColor(226, 232, 240); // #e2e8f0
                doc.rect(margin, finalY, contentWidth, 8, 'S');
                
                // Texto da barra
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(`${percentage.toFixed(1)}%`, margin + 5, finalY + 5.5);
                
                doc.setTextColor(100, 116, 139);
                doc.setFont('helvetica', 'normal');
                doc.text('0%', margin, finalY + 15);
                doc.text('50%', margin + (contentWidth / 2) - 5, finalY + 15);
                doc.text('100%', margin + contentWidth - 10, finalY + 15);
                
                finalY += 25;
                
                // Observa√ß√µes
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                doc.setFont('helvetica', 'bold');
                doc.text('Observa√ß√µes:', margin, finalY);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('1. Esta proposta tem validade de 30 dias a partir da data de emiss√£o.', margin, finalY + 7);
                doc.text('2. Valores sujeitos a altera√ß√£o sem aviso pr√©vio.', margin, finalY + 14);
                doc.text('3. Consulte condi√ß√µes espec√≠ficas para cada forma de pagamento.', margin, finalY + 21);
                
                // Rodap√©
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text('¬© 2024 Calculadora Imobili√°ria Profissional - Documento gerado automaticamente', 
                        pageWidth / 2, doc.internal.pageSize.getHeight() - 15, { align: 'center' });
                
                // Salvar PDF
                const fileName = `Proposta_${negocioCodigo}_${now.toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                // Restaurar bot√£o
                savePDFBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Salvar PDF';
                savePDFBtn.disabled = false;
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
                
                // Restaurar bot√£o em caso de erro
                savePDFBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Salvar PDF';
                savePDFBtn.disabled = false;
            }
        }

        // Imprimir documento (CORRIGIDO)
        function printDocument() {
            // Salvar o estado atual do input
            const originalInputValue = propertyValueInput.value;
            const originalDisplayValue = propertyValueDisplay.textContent;
            
            // Criar c√≥pia do container para impress√£o
            const printContainer = document.querySelector('.container').cloneNode(true);
            
            // Remover elementos com classe no-print
            const noPrintElements = printContainer.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.remove());
            
            // Remover bot√µes da toolbar
            const toolbarElements = printContainer.querySelectorAll('.toolbar, .btn');
            toolbarElements.forEach(el => el.remove());
            
            // Ajustar o input do valor do im√≥vel para impress√£o
            const currencyInput = printContainer.querySelector('.currency-input');
            const currencyPrefix = printContainer.querySelector('.currency-prefix');
            const currencyInputContainer = printContainer.querySelector('.currency-input-container');
            
            if (currencyInput && currencyPrefix && currencyInputContainer) {
                // Substituir input por span para impress√£o
                const displayValue = document.createElement('span');
                displayValue.className = 'currency-input-display';
                displayValue.textContent = formatNumber(propertyValue);
                displayValue.style.cssText = `
                    font-size: 14px;
                    font-weight: 700;
                    color: #1e3a8a;
                    text-align: right;
                    font-family: 'Inter', monospace;
                    letter-spacing: 0.5px;
                    display: inline-block;
                `;
                
                currencyInputContainer.innerHTML = '';
                currencyInputContainer.appendChild(currencyPrefix);
                currencyInputContainer.appendChild(displayValue);
                currencyInputContainer.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: flex-end;
                    gap: 10px;
                `;
                
                currencyPrefix.style.cssText = `
                    position: static;
                    font-size: 24px;
                    font-weight: 700;
                    color: #1e3a8a;
                `;
            }
            
            // Criar nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Proposta Imobili√°ria - ${negocioNome}</title>
                    <style>
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            padding: 10px;
                            color: #1e293b;
                            font-size: 12px;
                        }
                        .container {
                            max-width: 100%;
                            background: white;
                        }
                        .summary-cards {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            margin-bottom: 10px;
                        }
                        .payment-block {
                            border: 1px solid #ddd;
                            padding: 5x;
                            margin-bottom: 10px;
                            border-radius: 5px;
                            break-inside: avoid;
                        }
                        .summary-card {
                            border: 1px solid #ddd;
                            padding: 10px;
                            border-radius: 5px;
                        }
                        .valor-imovel-container {
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 8px;
                            margin-bottom: 10px;
                        }
                        .negocio-container {
                            background: #f0f7ff;
                            padding: 10px;
                            border-radius: 8px;
                            margin-bottom: 10px;
                            border-left: 4px solid #3b82f6;
                        }
                        .chart-container {
                            margin-top: 10px;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                        }
                        h1 {
                            color: #1e3a8a;
                            margin-bottom: 10px;
                        }
                        @media print {
                            body { padding: 10px; }
                            .summary-cards { grid-template-columns: repeat(4, 1fr); }
                        }
                        @page {
                            margin: 20px;
                        }
                    </style>
                </head>
                <body>
                    <h1>Proposta Imobili√°ria - ${negocioNome}</h1>
                    <p><strong>C√≥digo:</strong> ${negocioCodigo} | <strong>Emitido em:</strong> ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                    ${printContainer.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Esperar o conte√∫do carregar antes de imprimir
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
            
            // Restaurar valores originais (apenas para seguran√ßa)
            propertyValueInput.value = originalInputValue;
            propertyValueDisplay.textContent = originalDisplayValue;
        }

        // Exportar para JSON
        function exportToJSON() {
            const data = {
                negocio: {
                    nome: negocioNome,
                    codigo: negocioCodigo
                },
                propertyValue: propertyValue,
                paymentBlocks: paymentBlocks,
                exportDate: new Date().toISOString()
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proposta-${negocioCodigo || 'imobiliaria'}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Proposta "${negocioNome}" exportada com sucesso!`);
        }

        // Importar de JSON
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Importar dados do neg√≥cio
                    if (data.negocio) {
                        if (data.negocio.nome) {
                            negocioNome = data.negocio.nome;
                            negocioNomeInput.value = negocioNome;
                        }
                        if (data.negocio.codigo) {
                            negocioCodigo = data.negocio.codigo;
                            negocioCodigoInput.value = negocioCodigo;
                        }
                        updateNegocioInfo();
                    }
                    
                    if (data.propertyValue !== undefined) {
                        propertyValue = data.propertyValue;
                        const formatted = formatNumber(propertyValue);
                        propertyValueInput.value = formatted;
                        propertyValueDisplay.textContent = formatted;
                        propertySlider.value = propertyValue;
                    }
                    
                    if (Array.isArray(data.paymentBlocks)) {
                        paymentBlocks = data.paymentBlocks;
                        nextId = paymentBlocks.length > 0 ? Math.max(...paymentBlocks.map(b => b.id)) + 1 : 1;
                    }
                    
                    updatePropertyValue();
                    renderPaymentBlocks();
                    updateSummary();
                    alert(`Proposta "${negocioNome}" importada com sucesso!`);
                } catch (error) {
                    alert('Erro ao importar arquivo. Verifique se √© um JSON v√°lido.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }

        // Redefinir para padr√£o
        function resetToDefault() {
            propertyValue = 300000;
            const formatted = formatNumber(propertyValue);
            propertyValueInput.value = formatted;
            propertyValueDisplay.textContent = formatted;
            propertySlider.value = propertyValue;
            
            negocioNome = "Im√≥vel 22 - Empresarial";
            negocioCodigo = "PRO-2024-001";
            negocioNomeInput.value = negocioNome;
            negocioCodigoInput.value = negocioCodigo;
            
            paymentBlocks = [
                {
                    id: 1,
                    type: 'ato',
                    label: 'Ato - Entrada Inicial',
                    value: 127333.52,
                    date: '12/2025',
                    total: 127333.52
                },
                {
                    id: 2,
                    type: 'parcelamento',
                    label: 'Parcelas Mensais',
                    value: 9317.09,
                    installments: 41,
                    start: '05/2026',
                    end: '09/2028',
                    total: 382000.69
                },
                {
                    id: 3,
                    type: 'reforco',
                    label: 'Refor√ßo Anual 2026',
                    value: 31833.38,
                    date: '09/2026',
                    total: 31833.38
                },
                {
                    id: 4,
                    type: 'reforco',
                    label: 'Refor√ßo Anual 2027',
                    value: 31833.38,
                    date: '09/2027',
                    total: 31833.38
                },
                {
                    id: 5,
                    type: 'reforco',
                    label: 'Refor√ßo Anual 2028',
                    value: 31833.38,
                    date: '09/2028',
                    total: 31833.38
                },
                {
                    id: 6,
                    type: 'financiamento',
                    label: 'Financiamento Banc√°rio',
                    value: 955001.37,
                    date: '12/2029',
                    total: 955001.37
                }
            ];
            
            nextId = 7;
            selectedType = 'ato';
            
            typeButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('.type-btn[data-type="ato"]').classList.add('active');
            
            updateNegocioInfo();
            updatePropertyValue();
            renderPaymentForm();
            renderPaymentBlocks();
            updateSummary();
        }

        // Limpar todos os pagamentos
        function clearAllPayments() {
            if (confirm('Tem certeza que deseja remover todas as formas de pagamento?')) {
                paymentBlocks = [];
                nextId = 1;
                renderPaymentBlocks();
                updateSummary();
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
